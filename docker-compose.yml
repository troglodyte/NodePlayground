version: "3.8"

services:
  # Production backend (TypeScript -> Node)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: prod
    environment:
      - NODE_ENV=production
      - PORT=3000
    expose:
      - "3000"

  # Production Caddy serving built frontend and proxying /api to backend
  caddy:
    build:
      context: .
      dockerfile: caddy/Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend

  # Development profile (run with: docker compose --profile dev up --build)
  frontend-dev:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm ci || npm install && npm run dev -- --host"
    ports:
      - "5173:5173"
    volumes:
      - ./:/app
    profiles: ["dev"]

  backend-dev:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm ci || npm install && npm run dev"
    environment:
      - PORT=3000
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
    profiles: ["dev"]

  caddy-dev:
    image: caddy:2.8-alpine
    ports:
      - "80:80"
    volumes:
      - ./caddy/Caddyfile.dev:/etc/caddy/Caddyfile:ro
    depends_on:
      - frontend-dev
      - backend-dev
    profiles: ["dev"]
